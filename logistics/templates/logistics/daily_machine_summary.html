{% extends 'logistics/base.html' %}

{% block content %}
<header style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Daily Machine Summary</h1>
    <form method="get" style="display: flex; gap: 0.5rem; align-items: center;">
        <label for="date" style="color: var(--text-secondary);">Date:</label>
        <input type="date" id="date" name="date" value="{{ selected_date|date:'Y-m-d' }}"
            style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary);"
            onchange="this.form.submit()">
    </form>
</header>

<div class="stats-grid">
    <div class="stat-card">
        <div class="label">Total Machines</div>
        <div class="value">{{ total_machines }}</div>
    </div>
    <div class="stat-card success">
        <div class="label">Visited by Operator</div>
        <div class="value">{{ visited_count }}</div>
    </div>
    <div class="stat-card box-info" style="border-color: #3b82f6;">
        <div class="label" style="color: #60a5fa;">Visited by Car</div>
        <div class="value" style="color: #60a5fa;">{{ car_visited_count }}</div>
    </div>
    <div class="stat-card warning">
        <div class="label">Issues Reported</div>
        <div class="value">{{ issues_count }}</div>
    </div>
</div>

<div class="data-table">
    <table>
        <thead>
            <tr>
                <th>Machine</th>
                <th>Operator Visit</th>
                <th>Car Visit</th>
                <th>Transactions</th>
                <th>Location / Distance</th>
                <th>Status/Issues</th>
            </tr>
        </thead>
        <tbody>
            {% for row in summary_data %}
            <tr>
                <td>
                    <a href="{% url 'logistics:machine_detail' row.machine.id %}">
                        {{ row.machine.name }}
                    </a>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                        {{ row.machine.location|default:"" }}
                    </div>
                </td>

                <!-- Operator Visit Column -->
                <td>
                    {% if row.visit_logs %}
                    {% for vl in row.visit_logs %}
                    <div {% if not forloop.first
                        %}style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border);" {% endif %}>
                        <strong>{{ vl.operator.name|default:"Unknown" }}</strong>
                        {% if vl.is_check_in %}<span class="badge badge-success" style="font-size: 0.65rem;">IN</span>{%
                        else %}<span class="badge badge-warning" style="font-size: 0.65rem;">OUT</span>{% endif %}
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                            {{ vl.timestamp|time:"H:i" }}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <span style="color: var(--text-secondary);">-</span>
                    {% endif %}
                </td>

                <!-- Car Visit Column -->
                <td>
                    {% if row.car_stops %}
                    {% for stop in row.car_stops %}
                    <div>
                        <span>üöó {{ stop.car_log.driver.name|default:"Driver" }}</span>
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">(Stop #{{ stop.order|add:1
                            }})</span>
                    </div>
                    {% endfor %}
                    {% else %}
                    <span style="color: var(--text-secondary);">-</span>
                    {% endif %}
                </td>

                <!-- Transactions -->
                <td>
                    {% if row.visit_log %}
                    {{ row.visit_log.transactions }}
                    {% else %}
                    -
                    {% endif %}
                </td>

                <!-- Location / Distance Column -->
                <td>
                    {% if row.distance_display %}
                    <a href="{{ row.both_map_url }}" target="_blank"
                        style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #60a5fa; font-size: 0.85rem; text-decoration: none; font-weight: 600; transition: all 0.2s;">
                        üìç {{ row.distance_display }}
                    </a>
                    <div style="margin-top: 6px; display: flex; gap: 6px; flex-wrap: wrap;">
                        {% if row.machine_map_url %}
                        <a href="{{ row.machine_map_url }}" target="_blank"
                            style="font-size: 0.7rem; color: var(--text-secondary); text-decoration: underline;">
                            üè≠ Machine
                        </a>
                        {% endif %}
                        {% if row.visit_map_url %}
                        <a href="{{ row.visit_map_url }}" target="_blank"
                            style="font-size: 0.7rem; color: var(--text-secondary); text-decoration: underline;">
                            üë§ Visit
                        </a>
                        {% endif %}
                    </div>
                    {% elif row.machine_map_url %}
                    <a href="{{ row.machine_map_url }}" target="_blank"
                        style="font-size: 0.8rem; color: #60a5fa; text-decoration: none;">
                        üìç Machine
                    </a>
                    {% if row.visit_map_url %}
                    <br>
                    <a href="{{ row.visit_map_url }}" target="_blank"
                        style="font-size: 0.8rem; color: #60a5fa; text-decoration: none;">
                        üë§ Visit
                    </a>
                    {% endif %}
                    {% elif row.visit_map_url %}
                    <a href="{{ row.visit_map_url }}" target="_blank"
                        style="font-size: 0.8rem; color: #60a5fa; text-decoration: none;">
                        üë§ Visit
                    </a>
                    {% else %}
                    <span style="color: var(--text-secondary);">-</span>
                    {% endif %}
                </td>

                <!-- Status/Issues -->
                <td>
                    {% if row.visit_log.machine_issue or row.visit_log.product_issue %}
                    <span class="badge badge-danger">Op Issue</span>
                    <div style="font-size: 0.75rem; color: var(--danger); margin-top: 0.25rem;">
                        {{ row.visit_log.machine_issue }} {{ row.visit_log.product_issue }}
                    </div>
                    {% elif row.car_issues %}
                    <span class="badge badge-warning">Car Issue</span>
                    <div style="font-size: 0.75rem; color: var(--warning); margin-top: 0.25rem;">{{ row.car_issues }}
                    </div>
                    {% elif row.visit_log or row.car_stops %}
                    <span class="badge badge-success">Visited</span>
                    {% else %}
                    <span class="badge" style="background: var(--bg-hover); color: var(--text-secondary);">No
                        Visit</span>
                    {% endif %}
                </td>
            </tr>

            <!-- Visit Photos Row (grouped by visit log) -->
            {% for vl in row.visit_logs %}
            {% if vl.images.all %}
            <tr>
                <td colspan="6" style="padding: 12px 16px; background: var(--bg-hover);">
                    <div class="visit-photos-group">
                        <div class="visit-photos-header">
                            <span class="visit-photos-label">
                                üì∏ <strong>{{ vl.operator.name|default:"Unknown" }}</strong>
                                {% if vl.is_check_in %}<span class="badge badge-success"
                                    style="font-size: 0.65rem;">Check In</span>{% else %}<span
                                    class="badge badge-warning" style="font-size: 0.65rem;">Check Out</span>{% endif %}
                                &mdash; {{ vl.timestamp|date:"H:i, M d Y" }}
                            </span>
                            <span class="visit-photos-count">{{ vl.images.all|length }} photo{{
                                vl.images.all|length|pluralize }}</span>
                        </div>
                        <div class="visit-photos-grid">
                            {% for img in vl.images.all %}
                            <a href="{{ img.image.url }}" target="_blank" class="visit-photo-thumb">
                                <img src="{{ img.image.url }}" alt="Visit photo" loading="lazy">
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% endfor %}

            {% endfor %}
        </tbody>
    </table>
</div>

<style>
    .visit-photos-group {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg-card);
        padding: 12px;
    }

    .visit-photos-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
        gap: 6px;
    }

    .visit-photos-label {
        font-size: 0.85rem;
        color: var(--text-primary);
    }

    .visit-photos-count {
        font-size: 0.75rem;
        color: var(--text-secondary);
        background: var(--bg-hover);
        padding: 2px 8px;
        border-radius: 6px;
    }

    .visit-photos-grid {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .visit-photo-thumb {
        width: 100px;
        height: 100px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid var(--border);
        transition: transform 0.2s, border-color 0.2s;
        display: block;
    }

    .visit-photo-thumb:hover {
        transform: scale(1.05);
        border-color: var(--primary);
    }

    .visit-photo-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
</style>
{% endblock %}